# chrome-shanbay-v2

> shanbay chrome 网页查单词插件

是[jinntrance/shanbay-crx](https://github.com/jinntrance/shanbay-crx)的重构版

chrome商店地址：https://chrome.google.com/webstore/detail/%E6%89%87%E8%B4%9D%E5%8A%A9%E6%89%8Bv2/pkibohmmnmpgbnaoappgndlfncanookc


## 和原版的区别：
- 没有Webster了
- 没有快捷键
- 没有弹出框延时关闭
- 弹出框界面跟shanbay的一模一样了（抄的，能不一样么～～）
- 弹出框出现的位置友好了一点
- 代码上简洁了一点点，没有用外部库，全手撸（其实代码量不多）
- console里面打印的日志少了一点（逃～～

## 提供的功能
- 单词双击选中自动弹出释义
- 选中之后右键菜单查词
- 可供选择中英文释义
- 角标上显示今天还有多少单词需要背，这个是在扇贝网设置的
- 有定时提醒，默认3小时一次，提醒你非常丑，该背单词了😂
- 如果查询的是新词，会有一个添加的按钮，用来添加到单词本里。如果已经在你的单词本里，会有一个按钮叫我忘了，点击一下相当于把单词的熟悉度重置里，以后还得背的意思
- 登录之后点击插件图标，显示的背单词和批量添加生词的两个按钮，顾名思义咯。这功能是扇贝做的，按钮就是一扇贝网的链接。
- 由于内核的关系，这个插件也可以在360极速浏览器、QQ浏览器上使用，由于某些不可描述的原因，你可以去[这里](https://github.com/maicss/chrome-shanbay-v2/releases)下载crx包，然后拖到扩展管理界面就行了。



## 已知的问题

- 有些词语的释义渲染的很差。这个锅主要由扇贝的API来背……
- 网页中嵌套iframe的时候，不能正确触发事件。这个不打算处理。因为默认的获取选区方法是获取当前顶级文档下的选区。想要获取frame的选区必须得到frame的文档，但是页面不知道会嵌入多少个文档，所以这个很难处理。现在还在广泛使用嵌入frame的网页有网页播放器，网页邮箱，在一个网站获取一个社交的网站动态（比如微博）等。一个嵌套了frame的网页，对于用户来说，一眼是看不出来的。这个也不想弹出一个警告什么的，太丑了。所以，let it go吧。
- 刷新插件之后，页面不刷新，双击查词的时候，会出现找不到对象的错误。这个没搜到解决方案，官方开发论坛也说try...catch掉，然后就没有然后了……也就是说没有解决方案。而且正常使用不会出现这个问题的，是debug的时候才有，就算了吧。
- 在input和textarea里面双击的时候，能查询单词，但是弹出框的定位是在页面的左上角。这个是因为selection API在这两个里面获取到选区的offset就是俩0。也搜到了一些hack的方法，但是修改页面的DOM特别多（要做一个contentedible的div替换掉原来的textarea，然后再用其他标签动态插入定位blabla）这样会还要考虑原来可能有的表单提交什么的。也let it go得了。



## 吐槽：

主要对象是Shanbay API。

> 在2018年年底左右，扇贝API页面找不到了，然后陆续关闭了一些API，导致插件不能继续使用。直接使用的是官方私有的API

> 2019年年初的时候，扇贝关闭了用户信息API，导致如果想要在图标界面显示用户头像，有两个方法：
>   1, 用扇贝的登录API，但是这样需要写一个用户登录界面，这样的一个插件，要使用到用户账户密码总觉得不太好（有点用户隐私洁癖），而且作用就是展示一个用户头像
>   2, 爬取用户界面，解析出头像URL，然后把用户头像读成base64之后存起来，然后每次用户登录信息没有或者过期之后删除。
> 后来跟这个插件的唯一一个用户商量之后，他说没用，我就直接删除了头像展示🤣

1, 他们自己弹出框用的数据跟API返回的数据居然不一样，而且质量没有自己用的好。不知道这样设置的原因是什么

2, 返回单词语音的连接是HTTP的，而自己使用的单词语音资源是HTTPS的。这个问题是写第一版的时候，直接使用audio标签进行语音的处理的时候，在HTTPS的网站上发现的（后来因为GitHub的CSP导致这个方案死掉了）。这个是为了省钱？但是HTTPS的认证好像也不是很贵啊，免费的也行啊。

3, 返回数据格式不统一。中文释义跟英文释义的格式不一样。中文的词性一项经常是空的，就返回一个特长的一个字符串，里面包含了N多条目。用换行符分割的，开发者自己去解析。我想弄的好看点，词性加粗，然后跟后面的解释分开。但是因为返回内容没有一点规律，不得不放弃掉。

4, 实际上呢，因为是chrome的插件，chrome当然可以获得自己所有的cookies，直接使用Shanbay内部的API更简单粗暴，也不需要认证。我甚至给开发者发邮件说，你们这API使用体验不好的话，是变相让用户使用你们内部API，这样给你们的服务器带来的压力就没办法分类了，而且鉴于没有那么多限制，也不好控制开发者行为了。然后也没见人回复。就这吧，毕竟沪江还没API呢。

- 2020.10 扇贝关闭了原来的2.0API，使用了新的3.0API。又一次升级。

## 自我总结

- chrome的API，通用的浏览器插件开发的API
- CSP
- Web Audio API
- Mutations／MutationObserver
- JSDOC
